import { motion } from "framer-motion";
import React, { useCallback, useEffect, useRef, useState, type JSX } from "react";
import type { fn } from "../../../types";

const clipPathId = "inner-frame-clip";

function ContentContainer(props: { box: DOMRect | null; children: React.ReactNode; onClick: fn }) {
	return (
		props.box && (
			<motion.div
				transition={{ delay: 0.5, duration: 0.3 }}
				exit={{ opacity: 0, transition: { delay: 0 } }}
				initial={{ opacity: 0 }}
				animate={{ opacity: 1 }}
				style={{
					position: "absolute",
					zIndex: 1,
					height: props.box?.height,
					width: props.box?.width,
					top: props.box?.top,
					left: props.box?.left,
					overflow: "auto",
				}}
				className="glow-text"
				onClick={props.onClick}
			>
				{props.children}
			</motion.div>
		)
	);
}

export default function HologramDisplay(props: { children: React.ReactNode; onClick: fn }) {
	const [box, setBox] = useState<DOMRect | null>(null);
	const innerFrame = useRef<SVGRectElement | null>(null);

	function updateRect() {
		if (innerFrame.current) setBox(innerFrame.current.getBoundingClientRect().toJSON());
	}

	useEffect(() => {
		if (!innerFrame.current) return;

		window.addEventListener("resize", updateRect);
		return () => window.removeEventListener("resize", updateRect);
	});

	const rectCB = useCallback((node: SVGRectElement | null) => {
		innerFrame.current = node;
		console.log(node);
		updateRect();
	}, []);

	return (
		<>
			<ContentContainer box={box} {...props} />

			<AnimatedSVG>
				<svg
					onClick={props.onClick}
					style={{
						zIndex: 0,
						position: "absolute",
						top: "50%",
						left: "50%",
						transform: "translate(-50%,-50%)",
						width: "inherit",
						maxWidth: "calc(100vw - 2em)",
						maxHeight: "calc(100vh - 2em)",
					}}
					viewBox="0 0 4385 2285"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
				>
					{svg}
					<rect ref={rectCB} x="227.15" y="305.77" width="3931" height="1684" />

					<defs>
						<clipPath id={clipPathId}>
							<path
								d="M3425.35 2188.9H3368.48L3245.89 2102.18H3039.25L3058.56 2087.72H2674.42L2502.79 2001H2064.42L2083.72 2015.45H1451.6L1470.91 2001H1108.46L1091.29 2015.71H1007.73L939.27 2084.08H736.99L689.92 2131.09H204.25L202.97 2128.78C195.45 2115.23 185.52 2103.4 173.47 2093.63L171.81 2092.29V1420.05L210.75 1381.16V1106.07L171.81 1067.18V855.85L165.15 862.84V820.02L178.39 806.77L187.82 813.78V532.36L187.73 530.03V403.2L340.85 258.62L390.44 258.6L482.88 166.27H551.34L577.74 139.91H671.87L691.18 111H965.99L958.76 103.77H1015.63L1138.22 190.5H1344.85L1325.54 204.95H1709.69L1881.32 291.68H2319.69L2300.39 277.22H2932.5L2913.19 291.68H3275.64L3292.78 276.99H3376.38L3444.84 208.62H3647.12L3694.22 161.59H4171.65L4172.97 163.73C4182.35 179.04 4195.24 192.35 4210.25 202.21L4212.27 203.54V872.65L4173.37 911.51V1186.65L4212.27 1225.48V1436.83L4218.96 1429.81V1472.66L4205.71 1485.91L4196.29 1478.91V1760.35L4196.35 1762.66V1889.48L4043.22 2034.07H3993.69L3901.23 2126.4H3832.77L3806.37 2152.77H3712.24L3692.93 2181.68H3418.11L3425.35 2188.9Z"
								fill="#B1E8FF"
							/>
						</clipPath>
					</defs>

					<foreignObject width="100%" height="100%" clipPath={`url(#${clipPathId})`}>
						<motion.div
							transition={{ delay: 0.3, duration: 0.3 }}
							initial={{ height: 0 }}
							exit={{ height: 0, transition: { delay: 0 } }}
							animate={{ height: "100%" }}
							className="glass-morpihic hologram-bg"
							style={{
								position: "absolute",
								top: "50%",
								left: "50%",
								transform: `translate(-50%,-50%)`,
								width: "100%",
							}}
						/>
					</foreignObject>
				</svg>
			</AnimatedSVG>
		</>
	);
}

function animateChildren(node: JSX.Element) {
	if (!node) return null;

	// text nodes, unknown nodes
	if (typeof node !== "object") return node;

	const isDrawable =
		node.type === "path" ||
		node.type === "line" ||
		node.type === "polyline" ||
		node.type === "polygon" ||
		node.type === "circle" ||
		node.type === "ellipse";

	const MotionTag = isDrawable ? motion[node.type] : node.type;

	return isDrawable ? (
		<MotionTag
			key={node.key}
			{...node.props}
			variants={{
				hidden: {
					opacity: 0,
					y: 10,
				},
				show: {
					opacity: 1,
					y: 0,
					transition: {
						opacity: { duration: 0.4, ease: "easeOut" },
						y: { duration: 0.4, ease: "easeOut" },
					},
				},
			}}
		>
			{React.Children.map(node.props?.children, animateChildren)}
		</MotionTag>
	) : (
		<MotionTag key={node.key} {...node.props}>
			{React.Children.map(node.props?.children, animateChildren)}
		</MotionTag>
	);
}

function AnimatedSVG({ children }: { children: JSX.Element }) {
	return (
		<motion.svg
			initial="hidden"
			animate="show"
			exit="exit"
			variants={{
				hidden: {
					opacity: 1,
				},
				exit: {
					opacity: 0,
				},
				show: {
					transition: {
						staggerChildren: 0.004, // delay between elements
					},
				},
			}}
			{...children.props}
		>
			{React.Children.map(children.props.children, animateChildren)}
		</motion.svg>
	);
}

const svg = (
	<>
		<path
			d="M1897.87 224.04H3250.87L3251.13 223.81L3257.88 218.03L3385.74 108.41H4320.92V93.9501H3380.35L3245.52 209.59H1901.34L1729.68 122.86H1160.18L1037.59 36.1401H808.48V50.5901H1032.99L1155.58 137.32H1726.24L1897.87 224.04Z"
			fill="#2981E2"
		/>
		<path d="M84.02 2150.31H98.5V700.46H84.02V2150.31Z" fill="#2981E2" />
		<path
			d="M63.76 1524.84L84.02 1492.9L98.5 1470.06L118.76 1438.12V989.54L112.1 996.54L108.43 1000.41L98.5 1010.85L84.02 1026.05L63.76 1047.36V1524.84Z"
			fill="#2981E2"
		/>
		<path d="M63.76 2198.94H118.76V1600.35L98.5 1632.3L84.02 1655.14L63.76 1687.08V2198.94Z" fill="#2981E2" />
		<path
			d="M3073.83 238.5H3256.23L3273.36 223.81L3280.11 218.03L3391.09 122.86H3569.67L3550.36 108.41L3531.08 93.95L3511.77 79.5H3375L3240.13 195.13H3131.73L3112.42 209.59L3093.14 224.04L3073.83 238.5Z"
			fill="#29ABE2"
		/>
		<path d="M1196.7 108.67H1179.34V31.1299H1196.7V108.67Z" fill="#2981E2" />
		<path d="M1155.84 31.1401V100.35L1138.47 88.1501V31.1401H1155.84Z" fill="#2981E2" />
		<path d="M1114.97 31.1401V71.7001L1097.6 59.5001V31.1401H1114.97Z" fill="#2981E2" />
		<path d="M1074.09 31.1401V43.0201L1057.13 31.1401H1074.09Z" fill="#2981E2" />
		<path d="M1235.53 108.67H1218.16V31.1299H1235.53V108.67Z" fill="#2981E2" />
		<path d="M1274.35 108.67H1256.98V31.1299H1274.35V108.67Z" fill="#2981E2" />
		<path d="M1313.17 38.9202V108.67H1295.8V33.6802L1313.17 38.9202Z" fill="#2981E2" />
		<path d="M1351.98 50.5901V108.67H1334.62V45.3901L1351.98 50.5901Z" fill="#2981E2" />
		<path d="M1390.83 62.2999V108.67H1373.46V57.0698L1390.83 62.2999Z" fill="#2981E2" />
		<path d="M1429.65 73.98V108.67H1412.28V68.75L1429.65 73.98Z" fill="#2981E2" />
		<path d="M1468.47 85.6602V108.67H1451.1V80.4302L1468.47 85.6602Z" fill="#2981E2" />
		<path d="M1507.28 97.3398V108.67H1489.92V92.1099L1507.28 97.3398Z" fill="#2981E2" />
		<path
			d="M2004.14 194.88L1744.01 57.8301H1497.24V99.4901H1503.03V63.6101H1742.57L2001.44 200L2004.14 194.88Z"
			fill="#2981E2"
		/>
		<path d="M585.76 57.8201H837.43L808.48 28.9102H585.76V57.8201Z" fill="#2981E2" />
		<path d="M105.74 729.37V490.26H76.79V700.46L105.74 729.37Z" fill="#2981E2" />
		<path
			d="M3248.18 223.81H3354.62L3423.08 155.44H3625.36L3672.46 108.41L3675.76 105.11L3671.67 101.01L3664.26 108.41L3622.96 149.66H3420.68L3352.22 218.03H3248.18V223.81Z"
			fill="#2981E2"
		/>
		<path d="M47.6801 424.29L47.85 343.03L185.26 212.75L127.37 205.26L0 325.66V388.92L47.6801 424.29Z" fill="#2981E2" />
		<path d="M134.77 573.17V559.24L115.37 544.78V558.72L134.77 573.17Z" fill="#2981E2" />
		<path d="M134.77 600.09V586.12L115.37 571.67V585.63L134.77 600.09Z" fill="#2981E2" />
		<path d="M134.77 627V613.04L115.37 598.58V612.55L134.77 627Z" fill="#2981E2" />
		<path d="M134.77 653.91V639.95L115.37 625.5V639.46L134.77 653.91Z" fill="#2981E2" />
		<path d="M134.77 680.8V666.86L115.37 652.41V666.34L134.77 680.8Z" fill="#2981E2" />
		<path d="M134.77 707.71V693.78L115.37 679.32V693.26L122.18 698.32L127.97 702.65L134.77 707.71Z" fill="#2981E2" />
		<path d="M106.31 1000.41H112.1V798.11L127.97 782.24V693.52H122.18V779.87L106.31 795.71V1000.41Z" fill="#2981E2" />
		<path d="M320 205.45L368.66 205.42L461.12 113.09H529.58L557.16 85.54L445.69 86.73L320 205.45Z" fill="#2981E2" />
		<path
			d="M118.53 1398.34L118.76 1398.11L157.69 1359.23V1128.3L118.76 1089.42L118.36 1089.02L118.53 1398.34Z"
			fill="#2981E2"
		/>
		<path
			d="M3347.24 2256.84H3576.35V2242.39H3351.84L3229.25 2155.66H2658.59L2486.96 2068.93H1133.96L1133.67 2069.19L1126.92 2074.98L999.09 2184.57H63.9102V2199.02H1004.45L1139.31 2083.39H2483.49L2655.15 2170.11H3224.65L3347.24 2256.84Z"
			fill="#2981E2"
		/>
		<path d="M4286.3 1592.55H4300.78V142.69H4286.3V1592.55Z" fill="#2981E2" />
		<path
			d="M4266.04 1303.46L4272.73 1296.44L4276.4 1292.56L4286.3 1282.16L4300.78 1266.95L4321.04 1245.64V768.13L4300.78 800.08L4286.3 822.91L4266.04 854.86V1303.46Z"
			fill="#2981E2"
		/>
		<path d="M4266.04 692.62L4286.3 660.68L4300.78 637.84L4321.04 605.9V94.04H4266.04V692.62Z" fill="#2981E2" />
		<path
			d="M2651.67 2184.57H2840.75L2860.06 2170.11L2879.34 2155.66L2898.65 2141.21H2662.04L2490.41 2054.48H2225.05L2244.36 2068.93L2263.64 2083.39L2282.95 2097.84H2480.05L2651.67 2184.57Z"
			fill="#29ABE2"
		/>
		<path d="M3188.12 2184.31H3205.49V2261.86H3188.12V2184.31Z" fill="#2981E2" />
		<path d="M3228.99 2261.85V2192.64L3246.36 2204.84V2261.85H3228.99Z" fill="#2981E2" />
		<path d="M3269.86 2261.85V2221.29L3287.23 2233.49V2261.85H3269.86Z" fill="#2981E2" />
		<path d="M3310.73 2261.85V2249.97L3327.7 2261.85H3310.73Z" fill="#2981E2" />
		<path d="M3149.3 2184.31H3166.67V2261.86H3149.3V2184.31Z" fill="#2981E2" />
		<path d="M3110.48 2184.31H3127.85V2261.86H3110.48V2184.31Z" fill="#2981E2" />
		<path d="M3071.66 2254.07V2184.32H3089.03V2259.31L3071.66 2254.07Z" fill="#2981E2" />
		<path d="M3032.84 2242.39V2184.32H3050.21V2247.6L3032.84 2242.39Z" fill="#2981E2" />
		<path d="M2994 2230.69V2184.32H3011.36V2235.92L2994 2230.69Z" fill="#2981E2" />
		<path d="M2955.18 2219.01V2184.32H2972.55V2224.24L2955.18 2219.01Z" fill="#2981E2" />
		<path d="M2916.36 2207.33V2184.32H2933.73V2212.56L2916.36 2207.33Z" fill="#2981E2" />
		<path d="M2877.54 2195.65V2184.32H2894.91V2200.88L2877.54 2195.65Z" fill="#2981E2" />
		<path
			d="M2887.59 2235.16V2193.5H2881.8V2229.38H2642.26L2383.39 2092.99L2380.69 2098.11L2640.82 2235.16H2887.59Z"
			fill="#2981E2"
		/>
		<path d="M3576.35 2264.07H3799.07V2235.16H3547.41L3576.35 2264.07Z" fill="#2981E2" />
		<path d="M4279.07 1802.71H4308.01V1592.55L4279.07 1563.64V1802.71Z" fill="#2981E2" />
		<path
			d="M713.16 2191.97L720.57 2184.57L761.87 2143.34H964.16L1032.61 2074.98H1136.65V2069.19H1030.21L961.75 2137.56H759.47L712.4 2184.57L709.08 2187.89L713.16 2191.97Z"
			fill="#2981E2"
		/>
		<path
			d="M4337.14 1868.7L4336.97 1949.96L4199.56 2080.24L4257.46 2087.73L4384.82 1967.33V1904.07L4337.14 1868.7Z"
			fill="#2981E2"
		/>
		<path d="M4269.46 1748.22V1734.29L4250.06 1719.83V1733.77L4269.46 1748.22Z" fill="#2981E2" />
		<path d="M4269.46 1721.31V1707.37L4250.06 1692.92V1706.85L4269.46 1721.31Z" fill="#2981E2" />
		<path d="M4269.46 1694.39V1680.46L4250.06 1666.01V1679.94L4269.46 1694.39Z" fill="#2981E2" />
		<path d="M4269.46 1667.48V1653.55L4250.06 1639.09V1653.03L4269.46 1667.48Z" fill="#2981E2" />
		<path d="M4269.46 1640.57V1626.63L4250.06 1612.18V1626.11L4269.46 1640.57Z" fill="#2981E2" />
		<path
			d="M4269.46 1613.68V1599.72L4262.65 1594.66L4256.87 1590.32L4250.06 1585.26V1599.23L4269.46 1613.68Z"
			fill="#2981E2"
		/>
		<path
			d="M4256.87 1599.46H4262.65V1513.14L4278.52 1497.27V1292.56H4272.73V1494.87L4256.87 1510.74V1599.46Z"
			fill="#2981E2"
		/>
		<path
			d="M3827.67 2207.43L3939.14 2206.25L4064.83 2087.55H4016.17L3923.72 2179.89H3855.26L3827.67 2207.43Z"
			fill="#2981E2"
		/>
		<path
			d="M4266.48 1203.96L4266.3 894.64L4266.04 894.9L4227.14 933.75V1164.7L4266.04 1203.52L4266.48 1203.96Z"
			fill="#2981E2"
		/>
		<path d="M10.8999 1803.49V1760.63L52.7899 1696.35V1803.49H10.8999Z" fill="#2981E2" />
		<path d="M10.8999 1930V1822.87H52.7899V1930H10.8999Z" fill="#29ABE2" />
		<path d="M10.8999 2056.52V1949.39H52.7899V2056.52H10.8999Z" fill="#2981E2" />
		<path d="M3070.05 182.7L3090.17 195.49H2135.94L2156.06 182.7H3070.05Z" fill="#29ABE2" />
		<path d="M3034.52 160.12L3051.57 170.95H2174.55L2191.6 160.12H3034.52Z" fill="#29ABE2" />
		<path d="M3004.11 140.79L3018.74 150.09H2207.37L2222.01 140.79H3004.11Z" fill="#29ABE2" />
		<path d="M2977.79 124.06L2990.49 132.14H2235.63L2248.33 124.06H2977.79Z" fill="#29ABE2" />
		<path d="M1334.31 2113.18L1314.19 2100.4H2268.42L2248.3 2113.18H1334.31Z" fill="#29ABE2" />
		<path d="M1369.85 2135.76L1352.8 2124.93H2229.81L2212.76 2135.76H1369.85Z" fill="#29ABE2" />
		<path d="M1400.26 2155.09L1385.62 2145.79H2196.99L2182.35 2155.09H1400.26Z" fill="#29ABE2" />
		<path d="M1426.58 2171.82L1413.87 2163.74H2168.74L2156.04 2171.82H1426.58Z" fill="#29ABE2" />
		<path
			d="M873.06 2213.48H1009.83L1144.67 2097.84H1253.1L1272.41 2083.39L1291.69 2068.93L1311 2054.48H1128.6L1111.44 2069.19L1104.69 2074.98L993.74 2170.11H815.17L834.47 2184.57L853.75 2199.02L873.06 2213.48Z"
			fill="#29ABE2"
		/>
		<path
			d="M1894.42 238.5H2159.78L2140.47 224.04L2121.19 209.59L2101.88 195.13H1904.78L1733.13 108.41H1544.08L1524.77 122.86L1505.49 137.32L1486.18 151.77H1722.8L1894.42 238.5Z"
			fill="#29ABE2"
		/>
		<path
			d="M3675.28 2284.98H3965.68L4328.96 1941.95V1794.71L4300.01 1775.43L4271.07 1756.18L4242.12 1736.9V1904.6L4056.83 2079.55L3931.14 2198.25H3733.18L3713.87 2227.16L3694.59 2256.07L3675.28 2284.98Z"
			fill="#29ABE2"
		/>
		<path
			d="M134.68 548.08V380.38L445.69 86.73H643.66L662.96 57.82L682.24 28.91L701.55 0H411.15L47.8398 343.03V490.26L76.7899 509.54L105.74 528.8L134.68 548.08Z"
			fill="#29ABE2"
		/>

		<path
			d="M3425.71 2189.05H3368.84L3246.25 2102.33H3039.61L3058.92 2087.87H2674.78L2503.15 2001.15H2064.78L2084.08 2015.6H1451.96L1471.27 2001.15H1108.82L1091.65 2015.86H1008.09L939.63 2084.23H737.35L690.28 2131.24H204.61L203.33 2128.93C195.81 2115.38 185.88 2103.55 173.83 2093.78L172.17 2092.44V1420.2L211.11 1381.31V1106.22L172.17 1067.33V856L165.51 862.99V820.17L178.75 806.92L188.18 813.93V532.51L188.09 530.18V403.35L341.21 258.77L390.8 258.75L483.24 166.42H551.7L578.1 140.06H672.23L691.54 111.15H966.35L959.12 103.92H1015.99L1138.58 190.65H1345.21L1325.9 205.1H1710.05L1881.68 291.83H2320.05L2300.75 277.37H2932.86L2913.55 291.83H3276L3293.14 277.14H3376.74L3445.2 208.77H3647.48L3694.58 161.74H4172.01L4173.33 163.88C4182.71 179.19 4195.6 192.5 4210.61 202.36L4212.63 203.69V872.8L4173.73 911.66V1186.8L4212.63 1225.63V1436.98L4219.32 1429.96V1472.81L4206.07 1486.06L4196.65 1479.06V1760.5L4196.71 1762.81V1889.63L4043.58 2034.22H3994.05L3901.59 2126.55H3833.13L3806.73 2152.92H3712.6L3693.29 2181.83H3418.47L3425.71 2189.05ZM3371.7 2180.08H3404.04L3396.81 2172.85H3688.5L3707.8 2143.94H3803.02L3829.42 2117.57H3897.88L3990.34 2025.24H4040.02L4187.74 1885.75V1765.07L4187.69 1762.76V1461.21L4205.2 1474.23L4210.35 1469.09V1452.38L4203.67 1459.41V1229.34L4164.76 1190.51V907.93L4203.67 869.08V208.49C4189.12 198.53 4176.52 185.54 4167.02 170.7H3698.3L3651.2 217.74H3448.92L3380.46 286.1H3296.46L3279.32 300.79H2886.61L2905.92 286.34H2327.69L2347 300.79H1879.54L1707.92 214.07H1298.96L1318.27 199.61H1135.73L1013.14 112.88H980.8L988.03 120.11H696.34L677.03 149.02H581.81L555.42 175.39H486.96L394.51 267.7L344.78 267.73L197.06 407.21V527.91L197.15 530.23V831.77L179.62 818.74L174.48 823.88V840.55L181.14 833.56V1063.61L220.08 1102.49V1385.03L181.14 1423.91V2088.18C192.66 2097.83 202.31 2109.28 209.86 2122.26H686.57L733.64 2075.25H935.92L1008.09 2006.89H1088.34L1105.51 1992.17H1498.22L1478.91 2006.62H2057.14L2037.83 1992.17H2505.29L2676.92 2078.9H3085.87L3066.56 2093.35H3249.11L3371.7 2180.08Z"
			fill="#29ABE2"
		/>
	</>
);
